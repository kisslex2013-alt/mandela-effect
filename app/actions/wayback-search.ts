'use server';

interface WaybackImage {
  originalUrl: string;
  archiveUrl: string;
  timestamp: string;
  mimeType: string;
}

interface WaybackResult {
  success: boolean;
  images: WaybackImage[];
  logs: string[];
}

export async function searchWaybackImages(query: string): Promise<WaybackResult> {
  const logs: string[] = [];
  const log = (msg: string) => logs.push(`[${new Date().toLocaleTimeString()}] ${msg}`);

  try {
    if (!query || query.length < 2) {
      log('âŒ Ð—Ð°Ð¿Ñ€Ð¾Ñ ÑÐ»Ð¸ÑˆÐºÐ¾Ð¼ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ð¹');
      return { success: false, images: [], logs };
    }

    // 1. ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð·Ð°Ð¿Ñ€Ð¾ÑÐ° (Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ ÐºÐ¸Ñ€Ð¸Ð»Ð»Ð¸Ñ†Ñƒ!)
    // Ð£Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÑÐ¿ÐµÑ†ÑÐ¸Ð¼Ð²Ð¾Ð»Ñ‹, Ð¿Ñ€Ð¾Ð±ÐµÐ»Ñ‹ Ð¸ Ð´Ð²Ð¾ÐµÑ‚Ð¾Ñ‡Ð¸Ñ
    const cleanQuery = query.toLowerCase().replace(/[:;,"'!?]/g, '').trim(); 
    const isLatin = /^[a-z0-9\-\.]+$/.test(cleanQuery);
    
    log(`ðŸ” ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ñ‹Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ: "${cleanQuery}" (Latin: ${isLatin})`);

    let searchUrls: string[] = [];

    if (isLatin) {
      // Ð¡Ñ‚Ñ€Ð°Ñ‚ÐµÐ³Ð¸Ñ Ð´Ð»Ñ Ð°Ð½Ð³Ð»Ð¸Ð¹ÑÐºÐ¾Ð³Ð¾:
      // 1. Ð˜Ñ‰ÐµÐ¼ ÐºÐ°Ðº Ð´Ð¾Ð¼ÐµÐ½ (ÑÐ°Ð¼Ñ‹Ð¹ Ð½Ð°Ð´ÐµÐ¶Ð½Ñ‹Ð¹ ÑÐ¿Ð¾ÑÐ¾Ð± Ð½Ð°Ð¹Ñ‚Ð¸ Ð»Ð¾Ð³Ð¾Ñ‚Ð¸Ð¿Ñ‹)
      searchUrls.push(`*${cleanQuery}.com/*`);
      searchUrls.push(`${cleanQuery}.com/*`);
      // 2. Ð˜Ñ‰ÐµÐ¼ ÐºÐ°Ðº Ð¿Ð¾Ð´ÑÑ‚Ñ€Ð¾ÐºÑƒ (fallback)
      searchUrls.push(`*${cleanQuery}*`);
    } else {
      // Ð¡Ñ‚Ñ€Ð°Ñ‚ÐµÐ³Ð¸Ñ Ð´Ð»Ñ Ñ€ÑƒÑÑÐºÐ¾Ð³Ð¾: Ð¸Ñ‰ÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐºÐ°Ðº Ð¿Ð¾Ð´ÑÑ‚Ñ€Ð¾ÐºÑƒ, Ð½Ð¾ ÐºÐ¾Ð´Ð¸Ñ€ÑƒÐµÐ¼
      // Wayback Ð¿Ð»Ð¾Ñ…Ð¾ Ð¸Ñ‰ÐµÑ‚ ÐºÐ¸Ñ€Ð¸Ð»Ð»Ð¸Ñ†Ñƒ Ð² URL, Ð½Ð¾ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼
      const encoded = encodeURIComponent(cleanQuery);
      searchUrls.push(`*${encoded}*`);
    }

    let foundImages: WaybackImage[] = [];

    // ÐŸÐµÑ€ÐµÐ±Ð¸Ñ€Ð°ÐµÐ¼ ÑÑ‚Ñ€Ð°Ñ‚ÐµÐ³Ð¸Ð¸ Ð¿Ð¾ Ð¾Ñ‡ÐµÑ€ÐµÐ´Ð¸
    for (const urlPattern of searchUrls) {
      if (foundImages.length >= 10) break; // Ð¥Ð²Ð°Ñ‚Ð¸Ñ‚, ÐµÑÐ»Ð¸ ÑƒÐ¶Ðµ Ð½Ð°ÑˆÐ»Ð¸

      // Ð¤Ð¸Ð»ÑŒÑ‚Ñ€: Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐºÐ°Ñ€Ñ‚Ð¸Ð½ÐºÐ¸, ÑÑ‚Ð°Ñ‚ÑƒÑ 200, Ñ 1996 Ð¿Ð¾ 2012 Ð³Ð¾Ð´
      // collapse=digest Ð¿Ð¾Ð¼Ð¾Ð³Ð°ÐµÑ‚ ÑƒÐ±Ñ€Ð°Ñ‚ÑŒ Ð´ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ‚Ñ‹ Ð¾Ð´Ð½Ð¾Ð¹ Ð¸ Ñ‚Ð¾Ð¹ Ð¶Ðµ ÐºÐ°Ñ€Ñ‚Ð¸Ð½ÐºÐ¸
      const apiUrl = `https://web.archive.org/cdx/search/cdx?url=${urlPattern}&output=json&fl=original,timestamp,mimetype&filter=mimetype:image/.*&filter=statuscode:200&from=1996&to=2012&collapse=digest&limit=25`;
      
      log(`ðŸŒ ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ Ð¿Ð°Ñ‚Ñ‚ÐµÑ€Ð½: ${urlPattern}`);

      try {
        const response = await fetch(apiUrl, {
          headers: { 'User-Agent': 'MandelaResidueBot/2.0' },
          next: { revalidate: 60 } 
        });

        if (!response.ok) {
          log(`âš ï¸ ÐžÑˆÐ¸Ð±ÐºÐ° API (${response.status}) Ð´Ð»Ñ ${urlPattern}`);
          continue;
        }

        const textData = await response.text();
        if (!textData || textData.trim().length === 0) {
           log(`ðŸ’¨ ÐŸÑƒÑÑ‚Ð¾Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚ Ð´Ð»Ñ ${urlPattern}`);
           continue;
        }

        let data;
        try {
          data = JSON.parse(textData);
        } catch(e) { continue; }

        log(`ðŸ“¦ ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ Ð·Ð°Ð¿Ð¸ÑÐµÐ¹: ${data.length}`);

        // ÐŸÐ°Ñ€ÑÐ¸Ð½Ð³
        const startIndex = (data.length > 0 && data[0][0] === 'original') ? 1 : 0;
        
        for (let i = startIndex; i < data.length; i++) {
          const [original, timestamp, mime] = data[i];

          // Ð–ÐµÑÑ‚ÐºÐ¸Ð¹ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€ Ð¼ÑƒÑÐ¾Ñ€Ð°
          if (
             original.match(/(\.js|\.css|\.html|\.php)/) || // Ð¾ÑˆÐ¸Ð±Ð¾Ñ‡Ð½Ñ‹Ðµ mime
             original.includes('pixel') || 
             original.includes('spacer') ||
             original.includes('blank') ||
             original.includes('clear') ||
             original.includes('shim') ||
             original.includes('button') ||
             original.includes('nav') || 
             mime.includes('html') // Ð¸Ð½Ð¾Ð³Ð´Ð° API Ð²Ñ€ÐµÑ‚ Ð¿Ñ€Ð¾ mime
          ) continue;

          foundImages.push({
            originalUrl: original,
            archiveUrl: `https://web.archive.org/web/${timestamp}if_/${original}`,
            timestamp: `${timestamp.substring(0, 4)}-${timestamp.substring(4, 6)}`,
            mimeType: mime
          });
        }
      } catch (err) {
        log(`ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°: ${err}`);
      }
    }

    log(`âœ… Ð˜Ñ‚Ð¾Ð³Ð¾ ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ñ… Ñ„Ð¾Ñ‚Ð¾: ${foundImages.length}`);
    return { success: true, images: foundImages.slice(0, 20), logs };

  } catch (error: any) {
    log(`âŒ CRITICAL ERROR: ${error.message}`);
    return { success: false, images: [], logs };
  }
}
