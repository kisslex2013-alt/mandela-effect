'use server';

import OpenAI from 'openai';

// Ğ˜Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ Ğ´Ğ»Ñ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ° Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸
interface GeneratedEffectInfo {
  currentState: string;
  scientific: string;
  community: string;
  history: string;
  residue: string;
  // Ğ¡ÑÑ‹Ğ»ĞºĞ¸ Ğ½Ğ° Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ¸
  sourceLink: string;
  scientificSource: string;
  communitySource: string;
  historySource: string;
  residueSource: string;
  // ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ ÑÑ„Ñ„ĞµĞºÑ‚Ğ°
  category?: string;
  // ĞÑˆĞ¸Ğ±ĞºĞ° Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ (ĞµÑĞ»Ğ¸ AI ÑÑ‡Ğ¸Ñ‚Ğ°ĞµÑ‚ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ½ĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¼)
  error?: string;
}

interface GenerateResult {
  success: boolean;
  data?: GeneratedEffectInfo;
  error?: string;
}

/**
 * Ğ Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ±ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ñ‹Ñ… Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹ OpenRouter
 * Ğ•ÑĞ»Ğ¸ Ğ¾Ğ´Ğ½Ğ° Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ Ğ¿ĞµÑ€ĞµĞ³Ñ€ÑƒĞ¶ĞµĞ½Ğ° (429), Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ÑÑ Ğ½Ğ° ÑĞ»ĞµĞ´ÑƒÑÑ‰ÑƒÑ
 */
const FALLBACK_MODELS = [
  'google/gemini-2.0-flash-exp:free',
  'google/gemini-2.0-flash-lite-preview-02-05:free',
  'google/gemini-2.0-pro-exp-02-05:free',
  'x-ai/grok-4.1-fast:free',                         // Ğ§Ğ°ÑÑ‚Ğ¾ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ°, Ğ½Ğ¾ Ğ±Ñ‹ÑÑ‚Ñ€Ğ°Ñ
  'meta-llama/llama-3.3-70b-instruct:free',
  'mistralai/mistral-7b-instruct:free',
  'google/gemma-2-9b-it:free',
  'qwen/qwen-2.5-vl-72b-instruct:free',
  'qwen/qwen2.5-vl-72b-instruct:free',               // ĞĞ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ ÑĞ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚
  'alibaba/tongyi-deepresearch-30b-a3b:free',
  'deepseek/deepseek-r1:free',                       // Ğ˜Ğ½Ğ¾Ğ³Ğ´Ğ° Ğ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ğ°Ñ, Ğ½Ğ¾ ÑƒĞ¼Ğ½Ğ°Ñ
  'microsoft/phi-3-medium-128k-instruct:free',
];

/**
 * "Ğ›Ğ¸Ğ¿ĞºĞ°Ñ" Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ - Ğ·Ğ°Ğ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°ĞµĞ¼ Ğ¸Ğ½Ğ´ĞµĞºÑ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ¹ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ¹ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸
 * Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ°Ğ¼Ğ¸ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ generateEffectInfo
 */
let currentModelIndex = 0;

/**
 * ĞÑ‡Ğ¸Ñ‰Ğ°ĞµÑ‚ Ñ‚ĞµĞºÑÑ‚ Ğ¾Ñ‚ Markdown-Ğ¾Ğ±Ñ‘Ñ€Ñ‚Ğ¾Ğº (```json ... ```)
 * ĞĞ°Ğ´Ñ‘Ğ¶Ğ½Ğ¾ Ğ¸Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµÑ‚ JSON Ğ¸Ğ· Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° AI
 */
function cleanJsonResponse(rawText: string): string {
  let text = rawText.trim();
  
  console.log('[cleanJsonResponse] Ğ˜ÑÑ…Ğ¾Ğ´Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚ (Ğ¿ĞµÑ€Ğ²Ñ‹Ğµ 300 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²):', text.slice(0, 300));
  
  // Ğ¡Ğ¿Ğ¾ÑĞ¾Ğ± 1: Ğ ĞµĞ³ÑƒĞ»ÑÑ€ĞºĞ° Ğ´Ğ»Ñ Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ñ JSON Ğ¸Ğ· Ğ±Ğ»Ğ¾ĞºĞ° ```json ... ```
  const jsonBlockMatch = text.match(/```(?:json)?\s*([\s\S]*?)```/);
  if (jsonBlockMatch && jsonBlockMatch[1]) {
    console.log('[cleanJsonResponse] âœ… ĞĞ°Ğ¹Ğ´ĞµĞ½ JSON Ğ² markdown Ğ±Ğ»Ğ¾ĞºĞµ');
    text = jsonBlockMatch[1].trim();
  } else {
    // Ğ¡Ğ¿Ğ¾ÑĞ¾Ğ± 2: Ğ ÑƒÑ‡Ğ½Ğ°Ñ Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¸ ĞºĞ¾Ğ½Ñ†Ğ°
    if (text.startsWith('```json')) {
      text = text.slice(7);
    } else if (text.startsWith('```')) {
      text = text.slice(3);
    }
    
    if (text.endsWith('```')) {
      text = text.slice(0, -3);
    }
    
    text = text.trim();
  }
  
  // Ğ¡Ğ¿Ğ¾ÑĞ¾Ğ± 3: Ğ•ÑĞ»Ğ¸ Ñ‚ĞµĞºÑÑ‚ Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ĞµÑ‚ÑÑ Ğ½Ğµ Ñ {, Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ½Ğ°Ğ¹Ñ‚Ğ¸ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ {
  if (!text.startsWith('{')) {
    const firstBrace = text.indexOf('{');
    const lastBrace = text.lastIndexOf('}');
    if (firstBrace !== -1 && lastBrace !== -1 && lastBrace > firstBrace) {
      console.log('[cleanJsonResponse] âœ… Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ JSON Ğ¿Ğ¾ ÑĞºĞ¾Ğ±ĞºĞ°Ğ¼ { }');
      text = text.slice(firstBrace, lastBrace + 1);
    }
  }
  
  console.log('[cleanJsonResponse] ĞÑ‡Ğ¸Ñ‰ĞµĞ½Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚ (Ğ¿ĞµÑ€Ğ²Ñ‹Ğµ 300 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²):', text.slice(0, 300));
  
  return text;
}

/**
 * ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ»Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° "Ğ¿ĞµÑ€ĞµĞ³Ñ€ÑƒĞ·ĞºĞ¾Ğ¹" Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ (429, 503 Ğ¸ Ñ‚.Ğ´.)
 */
function isRetryableError(error: unknown): boolean {
  const errorMessage = error instanceof Error ? error.message : String(error);
  return (
    errorMessage.includes('429') ||
    errorMessage.includes('rate limit') ||
    errorMessage.includes('503') ||
    errorMessage.includes('unavailable') ||
    errorMessage.includes('overloaded') ||
    errorMessage.includes('capacity')
  );
}

/**
 * Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾Ğ± ÑÑ„Ñ„ĞµĞºÑ‚Ğµ ĞœĞ°Ğ½Ğ´ĞµĞ»Ñ‹ Ñ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ OpenRouter API
 * ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ°ĞµÑ‚ÑÑ Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ¼Ğ¾Ğ´ĞµĞ»ÑĞ¼Ğ¸ Ğ¿Ñ€Ğ¸ Ğ¿ĞµÑ€ĞµĞ³Ñ€ÑƒĞ·ĞºĞµ
 */
export async function generateEffectInfo(
  title: string,
  question: string
): Promise<GenerateResult> {
  console.log('');
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.log('[generateEffectInfo] ğŸš€ ĞĞĞ§ĞĞ›Ğ Ğ“Ğ•ĞĞ•Ğ ĞĞ¦Ğ˜Ğ˜ (OpenRouter + Fallback)');
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  
  // Ğ¨ĞĞ“ 1: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ API ĞºĞ»ÑÑ‡Ğ°
  const apiKey = process.env.OPENROUTER_API_KEY || process.env.GOOGLE_API_KEY;
  
  console.log('[generateEffectInfo] ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° API ĞºĞ»ÑÑ‡Ğ°...');
  console.log('[generateEffectInfo] OPENROUTER_API_KEY ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚:', !!process.env.OPENROUTER_API_KEY);
  console.log('[generateEffectInfo] GOOGLE_API_KEY ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚:', !!process.env.GOOGLE_API_KEY);
  console.log('[generateEffectInfo] Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼Ñ‹Ğ¹ ĞºĞ»ÑÑ‡ Ğ´Ğ»Ğ¸Ğ½Ğ¾Ğ¹:', apiKey ? apiKey.length : 0);
  
  if (!apiKey) {
    console.error('');
    console.error('âŒ ĞĞ¨Ğ˜Ğ‘ĞšĞ: API ĞºĞ»ÑÑ‡ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½!');
    console.error('Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ OPENROUTER_API_KEY Ğ² Ñ„Ğ°Ğ¹Ğ» .env Ğ¸Ğ»Ğ¸ .env.local');
    console.error('ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ĞºĞ»ÑÑ‡: https://openrouter.ai/keys');
    console.error('');
    return {
      success: false,
      error: 'API ĞºĞ»ÑÑ‡ Ğ½Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½. Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ OPENROUTER_API_KEY Ğ² .env Ñ„Ğ°Ğ¹Ğ».',
    };
  }

  // Ğ¨ĞĞ“ 2: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ²Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
  console.log('[generateEffectInfo] Ğ’Ñ…Ğ¾Ğ´Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ:');
  console.log('  - title:', title);
  console.log('  - question:', question);
  
  if (!title || title.trim().length < 3) {
    console.error('[generateEffectInfo] âŒ ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ ÑĞ»Ğ¸ÑˆĞºĞ¾Ğ¼ ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¾Ğµ');
    return {
      success: false,
      error: 'Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ ÑÑ„Ñ„ĞµĞºÑ‚Ğ° (Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 3 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ°)',
    };
  }

  // Ğ¨ĞĞ“ 3: Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ ĞºĞ»Ğ¸ĞµĞ½Ñ‚ OpenRouter
  console.log('[generateEffectInfo] Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ OpenRouter ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°...');
  const openai = new OpenAI({
    baseURL: 'https://openrouter.ai/api/v1',
    apiKey: apiKey,
    defaultHeaders: {
      'HTTP-Referer': process.env.NEXT_PUBLIC_SITE_URL || 'http://localhost:3000',
      'X-Title': 'Mandela Effect Admin',
    },
  });
  console.log('[generateEffectInfo] âœ… OpenRouter ĞºĞ»Ğ¸ĞµĞ½Ñ‚ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½');

  // Ğ¨ĞĞ“ 4: Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ¼Ñ‚
  const searchQuery = encodeURIComponent(`${title} Mandela effect`);
  
  const userPrompt = `ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ²Ğ²Ğ¾Ğ´Ğ¸Ñ‚ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ ÑÑ„Ñ„ĞµĞºÑ‚Ğ° ĞœĞ°Ğ½Ğ´ĞµĞ»Ñ‹: "${title}" Ğ¸ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ: "${question || 'ĞšĞ°Ğº Ğ²Ñ‹ ÑÑ‚Ğ¾ Ğ¿Ğ¾Ğ¼Ğ½Ğ¸Ñ‚Ğµ?'}".

Ğ’ĞµÑ€Ğ½Ğ¸ JSON Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ñ Ğ¿Ğ¾Ğ»ÑĞ¼Ğ¸ Ğ½Ğ° Ñ€ÑƒÑÑĞºĞ¾Ğ¼ ÑĞ·Ñ‹ĞºĞµ (Ñ‚ĞµĞºÑÑ‚) Ğ¸ Ğ°Ğ½Ğ³Ğ»Ğ¸Ğ¹ÑĞºĞ¾Ğ¼ (ÑÑÑ‹Ğ»ĞºĞ¸):

{
  "category": "ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ ÑÑ„Ñ„ĞµĞºÑ‚Ğ°",
  "currentState": "ĞšĞ°Ğº ÑÑ‚Ğ¾ Ğ²Ñ‹Ğ³Ğ»ÑĞ´Ğ¸Ñ‚ Ğ² Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸ ÑĞµĞ¹Ñ‡Ğ°Ñ. Ğ¤Ğ°ĞºÑ‚Ñ‹ Ğ¸ Ğ¾Ñ„Ğ¸Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ. 2-4 Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ.",
  "scientific": "ĞĞ°ÑƒÑ‡Ğ½Ğ¾Ğµ Ğ¾Ğ±ÑŠÑÑĞ½ĞµĞ½Ğ¸Ğµ ÑÑ‚Ğ¾Ğ³Ğ¾ ÑÑ„Ñ„ĞµĞºÑ‚Ğ°. ĞŸĞ¾Ñ‡ĞµĞ¼Ñƒ Ğ»ÑĞ´Ğ¸ Ğ¼Ğ¾Ğ³ÑƒÑ‚ Ğ¿Ğ¾Ğ¼Ğ½Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ¾ Ğ½ĞµĞ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾ Ñ Ñ‚Ğ¾Ñ‡ĞºĞ¸ Ğ·Ñ€ĞµĞ½Ğ¸Ñ Ğ¿ÑĞ¸Ñ…Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ğ¸ Ğ¸ ĞºĞ¾Ğ³Ğ½Ğ¸Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ğ½Ğ°ÑƒĞº. 2-4 Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ.",
  "community": "Ğ’ĞµÑ€ÑĞ¸Ñ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµÑÑ‚Ğ²Ğ°. ĞŸĞ¾Ñ‡ĞµĞ¼Ñƒ Ğ»ÑĞ´Ğ¸ Ğ¿Ğ¾Ğ¼Ğ½ÑÑ‚ Ğ¸Ğ½Ğ°Ñ‡Ğµ, ĞºĞ°ĞºĞ¸Ğµ Ñ‚ĞµĞ¾Ñ€Ğ¸Ğ¸ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‚ Ğ² Ğ¸Ğ½Ñ‚ĞµÑ€Ğ½ĞµÑ‚-ÑĞ¾Ğ¾Ğ±Ñ‰ĞµÑÑ‚Ğ²Ğ°Ñ… (Reddit, Ñ„Ğ¾Ñ€ÑƒĞ¼Ñ‹). 2-4 Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ.",
  "history": "ĞšÑ€Ğ°Ñ‚ĞºĞ°Ñ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¸Ğ»Ğ¸ Ñ‚Ğ°Ğ¹Ğ¼Ğ»Ğ°Ğ¹Ğ½. ĞšĞ¾Ğ³Ğ´Ğ° Ğ¿Ğ¾ÑĞ²Ğ¸Ğ»ÑÑ ÑÑ‚Ğ¾Ñ‚ ÑÑ„Ñ„ĞµĞºÑ‚, ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ´Ğ°Ñ‚Ñ‹, ĞºÑ‚Ğ¾ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¼ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ¸Ğ» Ğ²Ğ½Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ğµ. 2-4 Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ.",
  "residue": "ĞšĞĞĞšĞ Ğ•Ğ¢ĞĞ«Ğ• Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ñ‹ Ğ¾ÑÑ‚Ğ°Ñ‚ĞºĞ¾Ğ²/ĞºÑƒĞ»ÑŒÑ‚ÑƒÑ€Ğ½Ñ‹Ñ… ÑĞ»ĞµĞ´Ğ¾Ğ². ĞĞ• Ğ¿Ğ¸ÑˆĞ¸ Ğ¾Ğ±Ñ‰Ğ¸Ğµ Ñ„Ñ€Ğ°Ğ·Ñ‹ Ğ²Ñ€Ğ¾Ğ´Ğµ 'Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ½Ğ°Ğ¹Ñ‚Ğ¸ Ğ² ÑÑ‚Ğ°Ñ€Ñ‹Ñ… ĞºĞ½Ğ¸Ğ³Ğ°Ñ…'. ĞŸÑ€Ğ¸Ğ²Ğ¾Ğ´Ğ¸ Ğ¢ĞĞ›Ğ¬ĞšĞ ĞšĞĞĞšĞ Ğ•Ğ¢ĞĞ«Ğ• Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ñ‹: Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ Ñ„Ğ¸Ğ»ÑŒĞ¼Ğ¾Ğ² Ñ Ğ³Ğ¾Ğ´Ğ¾Ğ¼ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ°, ÑĞ¿Ğ¸Ğ·Ğ¾Ğ´Ñ‹ Ğ¼ÑƒĞ»ÑŒÑ‚Ñ„Ğ¸Ğ»ÑŒĞ¼Ğ¾Ğ² (Ğ¡Ğ¸Ğ¼Ğ¿ÑĞ¾Ğ½Ñ‹ S01E05, Ğ®Ğ¶Ğ½Ñ‹Ğ¹ Ğ¿Ğ°Ñ€Ğº S03E10), ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğµ Ğ±Ñ€ĞµĞ½Ğ´Ñ‹, Ğ¿Ğ°Ñ€Ğ¾Ğ´Ğ¸Ğ¸, Ğ¼ĞµĞ¼Ñ‹ Ğ¸Ğ»Ğ¸ Ğ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğµ Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ñ‹, Ğ³Ğ´Ğµ Ğ²Ğ¸Ğ´ĞµĞ½ ÑÑ‚Ğ¾Ñ‚ ÑÑ„Ñ„ĞµĞºÑ‚. 2-4 Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ Ñ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ¸ĞºĞ¾Ğ¹.",
  "sourceLink": "Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ½Ğ° Ñ„Ğ°ĞºÑ‚/Ğ¾Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¶ĞµĞ½Ğ¸Ğµ",
  "scientificSource": "Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ½Ğ° Ğ½Ğ°ÑƒÑ‡Ğ½Ñ‹Ğ¹ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº",
  "communitySource": "Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ½Ğ° Ğ¾Ğ±ÑÑƒĞ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ² ÑĞ¾Ğ¾Ğ±Ñ‰ĞµÑÑ‚Ğ²Ğµ",
  "historySource": "Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ½Ğ° Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ ÑÑ„Ñ„ĞµĞºÑ‚Ğ°",
  "residueSource": "Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ½Ğ° Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ñ‹ Ğ¾ÑÑ‚Ğ°Ñ‚ĞºĞ¾Ğ²"
}

ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ Ğ”Ğ›Ğ¯ ĞŸĞĞ›Ğ¯ "category":
Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸ ĞĞ”ĞĞ£ Ğ½Ğ°Ğ¸Ğ±Ğ¾Ğ»ĞµĞµ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´ÑÑ‰ÑƒÑ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ Ğ¸Ğ· ÑĞ¿Ğ¸ÑĞºĞ°:
- "films" â€” Ñ„Ğ¸Ğ»ÑŒĞ¼Ñ‹, ÑĞµÑ€Ğ¸Ğ°Ğ»Ñ‹, Ğ¼ÑƒĞ»ÑŒÑ‚Ñ„Ğ¸Ğ»ÑŒĞ¼Ñ‹, Ğ¢Ğ’-ÑˆĞ¾Ñƒ
- "music" â€” Ğ¿ĞµÑĞ½Ğ¸, Ğ¼ÑƒĞ·Ñ‹ĞºĞ°Ğ½Ñ‚Ñ‹, Ñ‚ĞµĞºÑÑ‚Ñ‹ Ğ¿ĞµÑĞµĞ½
- "brands" â€” Ğ»Ğ¾Ğ³Ğ¾Ñ‚Ğ¸Ğ¿Ñ‹, Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ Ğ±Ñ€ĞµĞ½Ğ´Ğ¾Ğ², ÑƒĞ¿Ğ°ĞºĞ¾Ğ²ĞºĞ¸
- "people" â€” Ğ·Ğ½Ğ°Ğ¼ĞµĞ½Ğ¸Ñ‚Ğ¾ÑÑ‚Ğ¸, Ğ¿Ğ¾Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ¸, Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ»Ğ¸Ñ‡Ğ½Ğ¾ÑÑ‚Ğ¸
- "popculture" â€” Ğ¼ĞµĞ¼Ñ‹, Ğ¸Ğ³Ñ€Ñ‹, Ğ¸Ğ½Ñ‚ĞµÑ€Ğ½ĞµÑ‚-ĞºÑƒĞ»ÑŒÑ‚ÑƒÑ€Ğ°, ĞºĞ¾Ğ¼Ğ¸ĞºÑÑ‹
- "geography" â€” ĞºĞ°Ñ€Ñ‚Ñ‹, ÑÑ‚Ñ€Ğ°Ğ½Ñ‹, Ğ³Ğ¾Ñ€Ğ¾Ğ´Ğ°
- "childhood" â€” Ğ´ĞµÑ‚ÑĞºĞ¸Ğµ ĞºĞ½Ğ¸Ğ³Ğ¸, Ğ¸Ğ³Ñ€ÑƒÑˆĞºĞ¸, Ğ¼ÑƒĞ»ÑŒÑ‚Ñ„Ğ¸Ğ»ÑŒĞ¼Ñ‹ Ğ´ĞµÑ‚ÑÑ‚Ğ²Ğ°
- "russian" â€” ÑÑ„Ñ„ĞµĞºÑ‚Ñ‹ ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ Ğ Ğ¾ÑÑĞ¸ĞµĞ¹, Ğ¡Ğ¡Ğ¡Ğ , Ñ€ÑƒÑÑĞºĞ¾Ğ¹ ĞºÑƒĞ»ÑŒÑ‚ÑƒÑ€Ğ¾Ğ¹
- "other" â€” ĞµÑĞ»Ğ¸ Ğ½Ğµ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ½Ğ¸ Ğ¾Ğ´Ğ½Ğ° ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ

Ğ•ÑĞ»Ğ¸ ÑĞ¾Ğ¼Ğ½ĞµĞ²Ğ°ĞµÑˆÑŒÑÑ â€” ÑÑ‚Ğ°Ğ²ÑŒ "other".

Ğ¡Ğ¢Ğ ĞĞ“Ğ˜Ğ• ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ Ğ”Ğ›Ğ¯ Ğ¡Ğ¡Ğ«Ğ›ĞĞš (*Source Ğ¿Ğ¾Ğ»ĞµĞ¹):

ğŸš« Ğ—ĞĞŸĞ Ğ•Ğ©Ğ•ĞĞ:
- ĞĞ±Ñ‰Ğ¸Ğµ ÑÑÑ‹Ğ»ĞºĞ¸ Ñ‚Ğ¸Ğ¿Ğ° "https://google.com", "https://reddit.com", "https://wikipedia.org"
- Ğ¡ÑÑ‹Ğ»ĞºĞ¸ Ğ±ĞµĞ· Ğ¿Ğ¾Ğ¸ÑĞºĞ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°

âœ… ĞĞ‘Ğ¯Ğ—ĞĞ¢Ğ•Ğ›Ğ¬ĞĞ:
- ĞšĞ°Ğ¶Ğ´Ğ°Ñ ÑÑÑ‹Ğ»ĞºĞ° Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ ĞšĞĞĞšĞ Ğ•Ğ¢ĞĞ«Ğ• ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ ÑĞ»Ğ¾Ğ²Ğ° Ğ¸Ğ· ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒÑÑ‰ĞµĞ³Ğ¾ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»Ñ
- Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚: https://www.google.com/search?q=ĞšĞ›Ğ®Ğ§Ğ•Ğ’Ğ«Ğ•+Ğ¡Ğ›ĞĞ’Ğ+ĞĞ+ĞĞĞ“Ğ›Ğ˜Ğ™Ğ¡ĞšĞĞœ

ğŸ“‹ ĞĞ›Ğ“ĞĞ Ğ˜Ğ¢Ğœ Ğ´Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»Ñ:
1. sourceLink â€” Ğ²ĞºĞ»ÑÑ‡Ğ¸ ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ñ„Ğ°ĞºÑ‚Ñ‹ Ğ¸Ğ· currentState
2. scientificSource â€” Ğ²ĞºĞ»ÑÑ‡Ğ¸ Ñ‚ĞµÑ€Ğ¼Ğ¸Ğ½Ñ‹ Ğ¸Ğ· scientific (psychology, false memory, confabulation)
3. communitySource â€” Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ Reddit Ğ¿Ğ¾Ğ¸ÑĞº: https://www.reddit.com/search/?q=Ğ—ĞĞŸĞ ĞĞ¡
4. historySource â€” Ğ²ĞºĞ»ÑÑ‡Ğ¸ Ğ´Ğ°Ñ‚Ñ‹ Ğ¸ Ğ¸Ğ¼ĞµĞ½Ğ° Ğ¸Ğ· history
5. residueSource â€” ĞĞ‘Ğ¯Ğ—ĞĞ¢Ğ•Ğ›Ğ¬ĞĞ Ğ²ĞºĞ»ÑÑ‡Ğ¸ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ñ‹ Ğ¸Ğ· residue (Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ ÑˆĞ¾Ñƒ, ÑĞ¿Ğ¸Ğ·Ğ¾Ğ´Ñ‹, Ğ±Ñ€ĞµĞ½Ğ´Ñ‹)

ĞŸĞ Ğ˜ĞœĞ•Ğ  Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾Ğ¹ ÑĞ²ÑĞ·ĞºĞ¸ residue + residueSource:
- residue: "Ğ’ ÑĞ¿Ğ¸Ğ·Ğ¾Ğ´Ğµ Ğ¡Ğ¸Ğ¼Ğ¿ÑĞ¾Ğ½Ğ¾Ğ² S15E10 Ğ²Ğ¸Ğ´ĞµĞ½ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ Ğ»Ğ¾Ğ³Ğ¾Ñ‚Ğ¸Ğ¿. Ğ˜Ğ³Ñ€ÑƒÑˆĞºĞ¸ Hot Wheels 1990-Ñ… ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ Ğ°Ğ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ñƒ."
- residueSource: "https://www.google.com/search?q=Volkswagen+logo+Simpsons+S15E10+Hot+Wheels+1990s+residue+evidence"

Ğ’ĞĞ–ĞĞ:
- ĞŸĞ¸ÑˆĞ¸ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ğ²Ğ½Ğ¾ Ğ½Ğ° Ñ€ÑƒÑÑĞºĞ¾Ğ¼ ÑĞ·Ñ‹ĞºĞµ
- ĞŸĞ¾Ğ»Ğµ "residue" ĞĞ‘Ğ¯Ğ—ĞĞ¢Ğ•Ğ›Ğ¬ĞĞ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ñ‹ (Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ, Ğ´Ğ°Ñ‚Ñ‹, ÑĞ¿Ğ¸Ğ·Ğ¾Ğ´Ñ‹)
- Ğ¡ÑÑ‹Ğ»ĞºĞ¸ Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞ¹ Ğ½Ğ° ĞĞĞ“Ğ›Ğ˜Ğ™Ğ¡ĞšĞĞœ ÑĞ·Ñ‹ĞºĞµ Ğ´Ğ»Ñ Ğ»ÑƒÑ‡ÑˆĞ¸Ñ… Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ² Ğ¿Ğ¾Ğ¸ÑĞºĞ°
- Ğ’ĞµÑ€Ğ½Ğ¸ Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ñ‹Ğ¹ JSON Ğ±ĞµĞ· markdown Ğ¾Ğ±Ñ‘Ñ€Ñ‚Ğ¾Ğº`;

  console.log('[generateEffectInfo] ğŸ“¤ ĞŸĞ ĞĞœĞ¢ ĞŸĞĞ”Ğ“ĞĞ¢ĞĞ’Ğ›Ğ•Ğ');
  console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
  console.log('User prompt:', userPrompt.slice(0, 200) + '...');
  console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');

  // Ğ¨ĞĞ“ 5: Ğ¦Ğ¸ĞºĞ» Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚Ğ¾Ğº Ñ Ñ€Ğ°Ğ·Ğ½Ñ‹Ğ¼Ğ¸ Ğ¼Ğ¾Ğ´ĞµĞ»ÑĞ¼Ğ¸ (Fallback)
  console.log('');
  console.log('[generateEffectInfo] ğŸ”„ Ğ—ĞĞŸĞ£Ğ¡Ğš Ğ¦Ğ˜ĞšĞ›Ğ FALLBACK ĞœĞĞ”Ğ•Ğ›Ğ•Ğ™');
  console.log(`[generateEffectInfo] Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ ${FALLBACK_MODELS.length} Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚Ğ¾Ğº`);
  console.log('');

  const failedModels: string[] = [];
  let lastError: unknown = null;

  // Ğ¦Ğ¸ĞºĞ» Ñ "Ğ»Ğ¸Ğ¿ĞºĞ¾Ğ¹" Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒÑ - Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ĞµĞ¼ Ñ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ¹ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ¹
  console.log(`[generateEffectInfo] ğŸ¯ ĞĞ°Ñ‡Ğ¸Ğ½Ğ°ĞµĞ¼ Ñ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ #${currentModelIndex}: ${FALLBACK_MODELS[currentModelIndex]}`);
  
  for (let i = 0; i < FALLBACK_MODELS.length; i++) {
    // Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ Ğ¸Ğ½Ğ´ĞµĞºÑ Ñ ÑƒÑ‡ĞµÑ‚Ğ¾Ğ¼ ÑĞ¼ĞµÑ‰ĞµĞ½Ğ¸Ñ (Ğ¸Ğ´Ñ‘Ğ¼ Ğ¿Ğ¾ ĞºÑ€ÑƒĞ³Ñƒ Ğ¾Ñ‚ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ¹ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ¹)
    const modelIndex = (currentModelIndex + i) % FALLBACK_MODELS.length;
    const model = FALLBACK_MODELS[modelIndex];
    
    console.log(`[generateEffectInfo] ğŸ”„ ĞŸÑ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ [${modelIndex}]: ${model}...`);
    
    try {
      const completion = await openai.chat.completions.create({
        model: model,
        messages: [
          {
            role: 'system',
            content: `ğŸš¨ Ğ¡Ğ¢Ğ ĞĞ“ĞĞ¯ ĞŸĞ ĞĞ’Ğ•Ğ ĞšĞ Ğ’Ğ¥ĞĞ”ĞĞ«Ğ¥ Ğ”ĞĞĞĞ«Ğ¥ (Ğ’Ğ«ĞŸĞĞ›ĞĞ˜ Ğ’ ĞŸĞ•Ğ Ğ’Ğ£Ğ® ĞĞ§Ğ•Ğ Ğ•Ğ”Ğ¬):

Ğ¢Ğ²Ğ¾Ñ ĞŸĞ•Ğ Ğ’ĞĞ¯ Ğ¸ Ğ“Ğ›ĞĞ’ĞĞĞ¯ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ° â€” Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ (title Ğ¸ question) Ğ½Ğ° Ğ°Ğ´ĞµĞºĞ²Ğ°Ñ‚Ğ½Ğ¾ÑÑ‚ÑŒ.

ĞšĞ Ğ˜Ğ¢Ğ•Ğ Ğ˜Ğ˜ ĞĞ¨Ğ˜Ğ‘ĞšĞ˜ (ĞµÑĞ»Ğ¸ Ğ›Ğ®Ğ‘ĞĞ™ Ğ¸Ğ· Ğ½Ğ¸Ñ… Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ÑÑ â€” ÑÑ‚Ğ¾ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°):
1. Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ ÑĞ¾ÑÑ‚Ğ¾Ğ¸Ñ‚ Ğ¸Ğ· Ğ¾Ğ±Ñ‰Ğ¸Ñ… ÑĞ»Ğ¾Ğ² ("Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ", "ÑÑ„Ñ„ĞµĞºÑ‚", "Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ", "Ñ‚ĞµÑÑ‚", "test", "string", "Ğ¿Ñ€Ğ¸Ğ²ĞµÑ‚", "hello", "Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€", "example").
2. Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ±ĞµÑÑĞ¼Ñ‹ÑĞ»ĞµĞ½Ğ½Ñ‹Ğ¹ ("Ñ„Ñ‹Ğ²Ñ„Ñ‹Ğ²", "asdasd", "qwerty", "Ğ¹Ñ†ÑƒĞºĞµĞ½", "Ğ°Ğ°Ğ°Ğ°Ğ°").
3. Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ½Ğµ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ¸ĞºĞ¸ â€” Ğ½ĞµĞ¿Ğ¾Ğ½ÑÑ‚Ğ½Ğ¾, Ğ¾ ĞºĞ°ĞºĞ¾Ğ¼ Ğ¸Ğ¼ĞµĞ½Ğ½Ğ¾ ÑĞ²Ğ»ĞµĞ½Ğ¸Ğ¸, Ğ±Ñ€ĞµĞ½Ğ´Ğµ, Ñ„Ğ¸Ğ»ÑŒĞ¼Ğµ Ğ¸Ğ»Ğ¸ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¸ Ğ¸Ğ´Ñ‘Ñ‚ Ñ€ĞµÑ‡ÑŒ.
4. Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ ÑĞ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ¾Ğ±Ñ‰Ğ¸Ğ¹ ("ÑÑ„Ñ„ĞµĞºÑ‚ Ğ¼Ğ°Ğ½Ğ´ĞµĞ»Ñ‹", "Ñ‡Ñ‚Ğ¾-Ñ‚Ğ¾ Ğ¿Ğ¾Ğ¼Ğ½Ñ", "ÑÑ‚Ñ€Ğ°Ğ½Ğ½Ğ¾Ğµ Ğ²Ğ¾ÑĞ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸Ğµ").

Ğ”Ğ•Ğ™Ğ¡Ğ¢Ğ’Ğ˜Ğ¯ ĞŸĞ Ğ˜ ĞĞ¨Ğ˜Ğ‘ĞšĞ•:
Ğ•ÑĞ»Ğ¸ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¿Ğ¾Ğ¿Ğ°Ğ´Ğ°ĞµÑ‚ Ğ¿Ğ¾Ğ´ Ğ›Ğ®Ğ‘ĞĞ™ ĞºÑ€Ğ¸Ñ‚ĞµÑ€Ğ¸Ğ¹ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸, Ñ‚Ñ‹ ĞĞ‘Ğ¯Ğ—ĞĞ Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ Ğ¢ĞĞ›Ğ¬ĞšĞ Ñ‚Ğ°ĞºĞ¾Ğ¹ JSON:
{ "error": "ĞĞµĞ¿Ğ¾Ğ½ÑÑ‚Ğ½Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ. Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ ÑÑ„Ñ„ĞµĞºÑ‚Ğ° (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: 'Ğ›Ğ¾Ğ³Ğ¾Ñ‚Ğ¸Ğ¿ Volkswagen', 'Ğ¤Ñ€Ğ°Ğ·Ğ° Ğ¸Ğ· Ğ—Ğ²ĞµĞ·Ğ´Ğ½Ñ‹Ñ… Ğ²Ğ¾Ğ¹Ğ½', 'Berenstain Bears')." }

ğŸš« Ğ¡Ğ¢Ğ ĞĞ“Ğ˜Ğ• Ğ—ĞĞŸĞ Ğ•Ğ¢Ğ«:
- Ğ—ĞĞŸĞ Ğ•Ğ©Ğ•ĞĞ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ»Ñ currentState, history, scientific, community, residue ĞµÑĞ»Ğ¸ Ğ¾Ğ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ°.
- Ğ—ĞĞŸĞ Ğ•Ğ©Ğ•ĞĞ Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ñ‚ĞµĞºÑÑ‚ Ñ Ğ¸Ğ·Ğ²Ğ¸Ğ½ĞµĞ½Ğ¸ÑĞ¼Ğ¸ ("Ğš ÑĞ¾Ğ¶Ğ°Ğ»ĞµĞ½Ğ¸Ñ...", "Ğ˜Ğ·Ğ²Ğ¸Ğ½Ğ¸Ñ‚Ğµ...") Ğ² Ğ»ÑĞ±Ğ¾Ğµ Ğ¿Ğ¾Ğ»Ğµ.
- Ğ—ĞĞŸĞ Ğ•Ğ©Ğ•ĞĞ Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚ Ğ¿Ñ€Ğ¾ ĞĞµĞ»ÑŒÑĞ¾Ğ½Ğ° ĞœĞ°Ğ½Ğ´ĞµĞ»Ñƒ, ĞµÑĞ»Ğ¸ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ½Ğµ Ğ¾ Ğ½Ñ‘Ğ¼ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾.
- Ğ•ÑĞ»Ğ¸ ÑÑ‚Ğ¾ Ğ½Ğµ Ğ¿Ğ¾Ñ…Ğ¾Ğ¶Ğµ Ğ½Ğ° Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑÑ„Ñ„ĞµĞºÑ‚ ĞœĞ°Ğ½Ğ´ĞµĞ»Ñ‹ â€” Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°Ğ¹ Ğ¢ĞĞ›Ğ¬ĞšĞ { "error": "..." }.

âœ… Ğ•Ğ¡Ğ›Ğ˜ Ğ—ĞĞŸĞ ĞĞ¡ Ğ’ĞĞ›Ğ˜Ğ”ĞĞ«Ğ™:
Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ ĞµÑĞ»Ğ¸ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ (Ğ±Ñ€ĞµĞ½Ğ´, Ñ„Ğ¸Ğ»ÑŒĞ¼, Ñ†Ğ¸Ñ‚Ğ°Ñ‚Ñƒ, ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ) â€” Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞ¹ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚.

---

Ğ¢Ñ‹ ÑĞºÑĞ¿ĞµÑ€Ñ‚ Ğ¿Ğ¾ Ğ­Ñ„Ñ„ĞµĞºÑ‚Ñƒ ĞœĞ°Ğ½Ğ´ĞµĞ»Ñ‹. ĞÑ‚Ğ²ĞµÑ‡Ğ°Ğ¹ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ñ‹Ğ¼ JSON Ğ±ĞµĞ· markdown Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.

ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞ˜Ğ• ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ Ğ”Ğ›Ğ¯ ĞŸĞĞ›Ğ•Ğ™ *Source (ÑÑÑ‹Ğ»ĞºĞ¸):

ğŸš« Ğ—ĞĞŸĞ Ğ•Ğ©Ğ•ĞĞ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°Ñ‚ÑŒ Ğ¾Ğ±Ñ‰Ğ¸Ğµ ÑÑÑ‹Ğ»ĞºĞ¸:
- ĞĞ• "https://google.com" Ğ¸Ğ»Ğ¸ "https://www.google.com"
- ĞĞ• "https://reddit.com" Ğ¸Ğ»Ğ¸ "https://www.reddit.com"  
- ĞĞ• "https://wikipedia.org" Ğ¸Ğ»Ğ¸ "https://en.wikipedia.org"
- ĞĞ• "https://google.ru" Ğ¸Ğ»Ğ¸ Ğ»ÑĞ±Ğ¾Ğ¹ Ğ´Ñ€ÑƒĞ³Ğ¾Ğ¹ Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğ¹ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹

âœ… ĞĞ‘Ğ¯Ğ—ĞĞ¢Ğ•Ğ›Ğ¬ĞĞ Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞ¹ ÑÑÑ‹Ğ»ĞºĞ¸ Ñ ĞŸĞĞ˜Ğ¡ĞšĞĞ’Ğ«Ğœ Ğ—ĞĞŸĞ ĞĞ¡ĞĞœ:
- ĞšĞ°Ğ¶Ğ´Ğ°Ñ ÑÑÑ‹Ğ»ĞºĞ° *Source Ğ”ĞĞ›Ğ–ĞĞ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğµ ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ ÑĞ»Ğ¾Ğ²Ğ° Ğ¸Ğ· Ñ‚Ğ²Ğ¾ĞµĞ³Ğ¾ Ñ‚ĞµĞºÑÑ‚Ğ°
- Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚: https://www.google.com/search?q=ĞšĞ›Ğ®Ğ§Ğ•Ğ’Ğ«Ğ•+Ğ¡Ğ›ĞĞ’Ğ+Ğ˜Ğ—+Ğ¢Ğ•ĞšĞ¡Ğ¢Ğ

ğŸ“‹ Ğ›ĞĞ“Ğ˜ĞšĞ Ğ“Ğ•ĞĞ•Ğ ĞĞ¦Ğ˜Ğ˜ Ğ¡Ğ¡Ğ«Ğ›ĞĞš:
1. Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ½Ğ°Ğ¿Ğ¸ÑˆĞ¸ Ñ‚ĞµĞºÑÑ‚ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»Ñ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, residue)
2. Ğ’Ñ‹Ğ´ĞµĞ»Ğ¸ Ğ¸Ğ· Ñ‚ĞµĞºÑÑ‚Ğ° 2-4 ĞšĞĞĞšĞ Ğ•Ğ¢ĞĞ«Ğ¥ Ñ„Ğ°ĞºÑ‚Ğ° (Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ, Ğ´Ğ°Ñ‚Ñ‹, ÑĞ¿Ğ¸Ğ·Ğ¾Ğ´Ñ‹)
3. Ğ¡Ğ¾ÑÑ‚Ğ°Ğ²ÑŒ Ğ¿Ğ¾Ğ¸ÑĞºĞ¾Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¸Ğ· ÑÑ‚Ğ¸Ñ… Ñ„Ğ°ĞºÑ‚Ğ¾Ğ²
4. Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° ĞŸĞĞ”Ğ¢Ğ’Ğ•Ğ Ğ–Ğ”ĞĞ¢Ğ¬ Ğ¸Ğ¼ĞµĞ½Ğ½Ğ¾ Ñ‚Ğµ Ñ„Ğ°ĞºÑ‚Ñ‹, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ñ‚Ñ‹ Ğ½Ğ°Ğ¿Ğ¸ÑĞ°Ğ»

ĞŸĞ Ğ˜ĞœĞ•Ğ  Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»Ñ residue:
- Ğ¢ĞµĞºÑÑ‚: "Ğ’ ÑĞ¿Ğ¸Ğ·Ğ¾Ğ´Ğµ Ğ¡Ğ¸Ğ¼Ğ¿ÑĞ¾Ğ½Ğ¾Ğ² S15E10 Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ ÑƒĞ²Ğ¸Ğ´ĞµÑ‚ÑŒ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ Ğ»Ğ¾Ğ³Ğ¾Ñ‚Ğ¸Ğ¿ VW. Ğ¢Ğ°ĞºĞ¶Ğµ Ğ¸Ğ³Ñ€ÑƒÑˆĞºĞ¸ Hot Wheels 1990-Ñ… Ğ³Ğ¾Ğ´Ğ¾Ğ² ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ Ğ°Ğ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ½ÑƒÑ Ğ²ĞµÑ€ÑĞ¸Ñ."
- Ğ¡ÑÑ‹Ğ»ĞºĞ°: "https://www.google.com/search?q=Volkswagen+logo+Simpsons+S15E10+Hot+Wheels+1990s+residue"

ĞĞ• Ğ”Ğ•Ğ›ĞĞ™ Ğ¢ĞĞš:
- Ğ¢ĞµĞºÑÑ‚ Ğ¿Ñ€Ğ¾ Ğ¡Ğ¸Ğ¼Ğ¿ÑĞ¾Ğ½Ğ¾Ğ² â†’ Ğ¡ÑÑ‹Ğ»ĞºĞ° "https://reddit.com" âŒ
- Ğ¢ĞµĞºÑÑ‚ Ğ¿Ñ€Ğ¾ Hot Wheels â†’ Ğ¡ÑÑ‹Ğ»ĞºĞ° "https://google.com/search?q=mandela+effect" âŒ`,
          },
          {
            role: 'user',
            content: userPrompt,
          },
        ],
        temperature: 0.7,
        max_tokens: 2000,
      });

      const rawText = completion.choices[0]?.message?.content || '';

      console.log('');
      console.log(`[generateEffectInfo] âœ… ĞœĞĞ”Ğ•Ğ›Ğ¬ ${model} ĞĞ¢Ğ’Ğ•Ğ¢Ğ˜Ğ›Ğ!`);
      console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
      console.log('ĞœĞ¾Ğ´ĞµĞ»ÑŒ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ°:', completion.model);
      console.log('Ğ¢Ğ¾ĞºĞµĞ½Ğ¾Ğ² Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¾:', completion.usage?.total_tokens || 'N/A');
      console.log('');
      console.log('Ğ¢ĞµĞºÑÑ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°:');
      console.log(rawText);
      console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');

      if (!rawText) {
        console.warn(`[generateEffectInfo] âš ï¸ ĞœĞ¾Ğ´ĞµĞ»ÑŒ ${model} Ğ²ĞµÑ€Ğ½ÑƒĞ»Ğ° Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚, Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ ÑĞ»ĞµĞ´ÑƒÑÑ‰ÑƒÑ...`);
        failedModels.push(model);
        continue;
      }

      // Ğ¨ĞĞ“ 6: ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ¾Ñ‚ Markdown
      const cleanedText = cleanJsonResponse(rawText);

      console.log('');
      console.log('[generateEffectInfo] ğŸ§¹ ĞĞ§Ğ˜Ğ©Ğ•ĞĞĞ«Ğ™ JSON:');
      console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
      console.log(cleanedText);
      console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');

      // Ğ¨ĞĞ“ 7: ĞŸĞ°Ñ€ÑĞ¸Ğ¼ JSON
      let parsed: GeneratedEffectInfo;
      try {
        parsed = JSON.parse(cleanedText);
        console.log('[generateEffectInfo] âœ… JSON ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ñ€Ğ°ÑĞ¿Ğ°Ñ€ÑĞµĞ½');
      } catch (parseError) {
        console.error('');
        console.error('[generateEffectInfo] âŒ ĞĞ¨Ğ˜Ğ‘ĞšĞ ĞŸĞĞ Ğ¡Ğ˜ĞĞ“Ğ JSON:');
        console.error('ĞÑˆĞ¸Ğ±ĞºĞ°:', parseError);
        console.error('Ğ¢ĞµĞºÑÑ‚ Ğ´Ğ»Ñ Ğ¿Ğ°Ñ€ÑĞ¸Ğ½Ğ³Ğ°:', cleanedText);
        console.error('');
        
        // ĞŸĞ¾Ğ¿Ñ‹Ñ‚ĞºĞ° Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ÑŒ Ñ…Ğ¾Ñ‚ÑŒ Ñ‡Ñ‚Ğ¾-Ñ‚Ğ¾ Ğ¸Ğ· Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°
        console.log('[generateEffectInfo] ĞŸÑ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ°Ğ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ Ğ¿Ğ°Ñ€ÑĞ¸Ğ½Ğ³...');
        try {
          // Ğ˜Ñ‰ĞµĞ¼ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ JSON Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ñ Ğ²Ğ»Ğ¾Ğ¶ĞµĞ½Ğ½Ñ‹Ğ¼Ğ¸ ÑĞºĞ¾Ğ±ĞºĞ°Ğ¼Ğ¸
          const jsonMatch = cleanedText.match(/\{[^{}]*(?:\{[^{}]*\}[^{}]*)*\}/);
          if (jsonMatch) {
            parsed = JSON.parse(jsonMatch[0]);
            console.log('[generateEffectInfo] âœ… ĞĞ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ Ğ¿Ğ°Ñ€ÑĞ¸Ğ½Ğ³ ÑƒÑĞ¿ĞµÑˆĞµĞ½');
          } else {
            throw new Error('ĞĞµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ JSON Ğ¾Ğ±ÑŠĞµĞºÑ‚');
          }
        } catch {
          console.warn(`[generateEffectInfo] âš ï¸ ĞœĞ¾Ğ´ĞµĞ»ÑŒ ${model} Ğ²ĞµÑ€Ğ½ÑƒĞ»Ğ° Ğ½ĞµĞ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ñ‹Ğ¹ JSON, Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ ÑĞ»ĞµĞ´ÑƒÑÑ‰ÑƒÑ...`);
          failedModels.push(model);
          continue;
        }
      }

      // Ğ¨ĞĞ“ 8: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ²ĞµÑ€Ğ½ÑƒĞ» Ğ»Ğ¸ AI Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸
      if (parsed.error) {
        console.log('[generateEffectInfo] âš ï¸ AI Ğ²ĞµÑ€Ğ½ÑƒĞ» Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸:', parsed.error);
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        console.log('');
        
        // Ğ—Ğ°Ğ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°ĞµĞ¼ ÑÑ‚Ñƒ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ ĞºĞ°Ğº Ñ€Ğ°Ğ±Ğ¾Ñ‡ÑƒÑ (Ğ´Ğ°Ğ¶Ğµ ĞµÑĞ»Ğ¸ Ğ²ĞµÑ€Ğ½ÑƒĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ - Ğ¾Ğ½Ğ° Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚)
        currentModelIndex = modelIndex;
        
        // Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ ÑƒÑĞ¿ĞµÑ…, Ğ½Ğ¾ Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¾Ğ¹ Ğ² data â€” ĞºĞ»Ğ¸ĞµĞ½Ñ‚ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ ÑÑ‚Ğ¾ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ
        return {
          success: true,
          data: parsed,
        };
      }

      // Ğ¨ĞĞ“ 9: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ Ğ¿Ğ¾Ğ»ĞµĞ¹ Ğ¸ Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ Ğ¿ÑƒÑÑ‚Ñ‹Ğµ
      const requiredFields: (keyof GeneratedEffectInfo)[] = [
        'currentState',
        'scientific',
        'community',
        'history',
        'residue',
        'sourceLink',
        'scientificSource',
        'communitySource',
        'historySource',
        'residueSource',
      ];

      console.log('[generateEffectInfo] ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ¾Ğ»ĞµĞ¹:');
      for (const field of requiredFields) {
        const hasField = !!parsed[field];
        console.log(`  - ${field}: ${hasField ? 'âœ…' : 'âš ï¸ Ğ¿ÑƒÑÑ‚Ğ¾'}`);
        if (!parsed[field]) {
          parsed[field] = '';
        }
      }

      console.log('');
      console.log('[generateEffectInfo] âœ… Ğ“Ğ•ĞĞ•Ğ ĞĞ¦Ğ˜Ğ¯ Ğ£Ğ¡ĞŸĞ•Ğ¨ĞĞ!');
      console.log(`[generateEffectInfo] Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ° Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ [${modelIndex}]: ${model}`);
      if (failedModels.length > 0) {
        console.log(`[generateEffectInfo] ĞŸÑ€Ğ¾Ğ¿ÑƒÑ‰ĞµĞ½Ñ‹ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸: ${failedModels.join(', ')}`);
      }
      console.log('[generateEffectInfo] Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚:', JSON.stringify(parsed, null, 2));
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log('');

      // Ğ—Ğ°Ğ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°ĞµĞ¼ ÑÑ‚Ñƒ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ ĞºĞ°Ğº Ñ€Ğ°Ğ±Ğ¾Ñ‡ÑƒÑ Ğ´Ğ»Ñ ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ñ… Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ¾Ğ²
      currentModelIndex = modelIndex;
      console.log(`[generateEffectInfo] ğŸ¯ Ğ—Ğ°Ğ¿Ğ¾Ğ¼Ğ½Ğ¸Ğ»Ğ¸ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ #${modelIndex} ĞºĞ°Ğº Ñ€Ğ°Ğ±Ğ¾Ñ‡ÑƒÑ`);

      return {
        success: true,
        data: parsed,
      };

    } catch (error) {
      lastError = error;
      const errorMessage = error instanceof Error ? error.message : String(error);
      
      console.error('');
      console.error(`[generateEffectInfo] âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ ${model}:`);
      console.error('Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ:', errorMessage);
      
      if (isRetryableError(error)) {
        console.warn(`[generateEffectInfo] âš ï¸ ĞœĞ¾Ğ´ĞµĞ»ÑŒ ${model} Ğ¿ĞµÑ€ĞµĞ³Ñ€ÑƒĞ¶ĞµĞ½Ğ° (429/503), Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ÑÑ Ğ½Ğ° ÑĞ»ĞµĞ´ÑƒÑÑ‰ÑƒÑ...`);
        failedModels.push(model);
        continue;
      }
      
      // Ğ•ÑĞ»Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ½Ğµ ÑĞ²ÑĞ·Ğ°Ğ½Ğ° Ñ Ğ¿ĞµÑ€ĞµĞ³Ñ€ÑƒĞ·ĞºĞ¾Ğ¹ - ÑÑ‚Ğ¾ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°
      if (errorMessage.includes('401') || errorMessage.includes('Unauthorized')) {
        console.error('[generateEffectInfo] âŒ ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°: Ğ½ĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ API ĞºĞ»ÑÑ‡');
        return {
          success: false,
          error: 'ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ API ĞºĞ»ÑÑ‡. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ OPENROUTER_API_KEY Ğ² .env Ñ„Ğ°Ğ¹Ğ»Ğµ.',
        };
      }
      
      // Ğ”Ğ»Ñ Ğ´Ñ€ÑƒĞ³Ğ¸Ñ… Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ ÑĞ»ĞµĞ´ÑƒÑÑ‰ÑƒÑ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ
      console.warn(`[generateEffectInfo] âš ï¸ ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ ${model}, Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ ÑĞ»ĞµĞ´ÑƒÑÑ‰ÑƒÑ...`);
      failedModels.push(model);
      continue;
    }
  }

  // Ğ•ÑĞ»Ğ¸ Ğ²ÑĞµ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Ğ½Ğµ ÑÑ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ»Ğ¸
  console.error('');
  console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.error('[generateEffectInfo] âŒ Ğ’Ğ¡Ğ• ĞœĞĞ”Ğ•Ğ›Ğ˜ ĞĞ•Ğ”ĞĞ¡Ğ¢Ğ£ĞŸĞĞ«!');
  console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.error('ĞŸÑ€Ğ¾Ğ±Ğ¾Ğ²Ğ°Ğ»Ğ¸ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸:', failedModels.join(', '));
  console.error('ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½ÑÑ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°:', lastError instanceof Error ? lastError.message : String(lastError));
  console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.error('');

  return {
    success: false,
    error: `Ğ’ÑĞµ AI Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Ğ¿ĞµÑ€ĞµĞ³Ñ€ÑƒĞ¶ĞµĞ½Ñ‹. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ñ‡ĞµÑ€ĞµĞ· Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¼Ğ¸Ğ½ÑƒÑ‚. (ĞŸÑ€Ğ¾Ğ±Ğ¾Ğ²Ğ°Ğ»Ğ¸: ${failedModels.length} Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹)`,
  };
}
